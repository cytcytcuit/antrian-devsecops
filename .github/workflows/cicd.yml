name: Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  # ============================  
  #       SAST - SONARQUBE
  # ============================  
  sonarqube:
    name: Static Code Analysis (SAST)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: SonarQube Scan
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "Starting SonarQube Scan..."
          ./gradlew sonar \
            -Dsonar.projectKey=myproject \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN

  # ============================  
  #       DAST - OWASP ZAP
  # ============================  
  zap_dast:
    name: Dynamic App Security Testing (DAST)
    runs-on: ubuntu-latest
    needs: sonarqube

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare Workspace Path
        run: |
          echo "GitHub Workspace: $GITHUB_WORKSPACE"

      - name: Run ZAP Baseline Scan
        env:
          ZAP_TARGET_URL: ${{ secrets.ZAP_TARGET_URL }}
        run: |
          echo "Starting DAST scan on target: $ZAP_TARGET_URL"

          docker run \
            -v ${{ github.workspace }}:/zap/wrk \
            -t ghcr.io/zaproxy/zaproxy:stable \
              zap-baseline.py \
                -t "$ZAP_TARGET_URL" \
                -r zap_report.html

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v3
        with:
          name: ZAP-DAST-Report
          path: zap_report.html
